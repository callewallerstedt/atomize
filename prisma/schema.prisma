generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum SubscriptionLevel {
  Free
  Paid
  Tester
  mylittlepwettybebe
}

model User {
  id                   String                @id @default(cuid())
  username             String                @unique
  email                String?               @unique
  password             String
  subscriptionLevel    SubscriptionLevel     @default(Free)
  subscriptionStart    DateTime?
  subscriptionEnd      DateTime?
  billingPeriod        String? // "monthly" | "yearly"
  paymentStatus        String? // "active" | "past_due" | "canceled"
  promoCodeUsed        String?
  lastLoginAt          DateTime?
  preferences          Json?                 // User preferences (preferredTitle, etc.)
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  sessions             Session[]
  subjects             Subject[]
  subjectData          SubjectData[]
  examSnipes           ExamSnipeHistory[]
  promoCodeRedemptions PromoCodeRedemption[]
  usageStats           UsageStats?
  feedback             Feedback[]
  sharedCourses        SharedCourse[]
  coSolveHistory       CoSolveHistory[]
  coSolveCanvases      CoSolveCanvas[]
}

model CoSolveHistory {
  id        String   @id @default(cuid())
  userId    String
  // Store a compressed screenshot as a data URL (usually image/jpeg)
  imageData String   @db.Text
  // Markdown/LaTeX response returned from the model
  response  String   @db.Text
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
}

model CoSolveCanvas {
  id           String   @id @default(cuid())
  userId       String
  name         String
  strokes      Json
  textElements Json
  pdfOverlays  Json?
  canvasBg     String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, updatedAt])
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  createdAt DateTime @default(now())
  expiresAt DateTime
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Subject {
  id        String   @id @default(cuid())
  userId    String
  name      String
  slug      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, slug])
}

model SubjectData {
  id        String   @id @default(cuid())
  userId    String
  slug      String
  data      Json
  sharedByUsername String? // Username of the latest user who shared this course
  updatedAt DateTime @updatedAt
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, slug])
}

model PromoCode {
  id                String                @id @default(cuid())
  code              String                @unique
  description       String?
  subscriptionLevel SubscriptionLevel
  expiresAt         DateTime?             // When the code itself expires (can't be redeemed after this)
  validityDays      Int?                  // How many days each user gets from when they redeem (null = unlimited)
  maxUses           Int?
  currentUses       Int                   @default(0)
  createdAt         DateTime              @default(now())
  redemptions       PromoCodeRedemption[]
}

model PromoCodeRedemption {
  id          String    @id @default(cuid())
  promoCodeId String
  userId      String
  redeemedAt  DateTime  @default(now())
  promoCode   PromoCode @relation(fields: [promoCodeId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([promoCodeId, userId])
}

model UsageStats {
  id               String   @id @default(cuid())
  userId           String   @unique
  coursesCreated   Int      @default(0)
  lessonsGenerated Int      @default(0)
  apiCalls         Int      @default(0)
  lastResetAt      DateTime @default(now())
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model ExamSnipeHistory {
  id         String   @id @default(cuid())
  userId     String
  courseName String
  slug       String
  subjectSlug String? // Link to Subject slug (nullable for backward compatibility)
  fileNames  Json
  results    Json
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, slug])
  @@index([userId, createdAt])
  @@index([userId, subjectSlug])
}

model Feedback {
  id        String   @id @default(cuid())
  userId    String
  message   String
  page      String   // The page/route where feedback was submitted
  done      Boolean  @default(false) // Mark if feedback has been addressed
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([createdAt])
}

model SharedCourse {
  id        String   @id @default(cuid())
  shareId   String   @unique // Unique share identifier for URL
  userId    String   // User who shared the course
  courseSlug String  // Slug of the shared course
  courseName String  // Name of the course
  courseData Json    // Full course data (without surgeLog and practiceLogs)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([shareId])
  @@index([userId, createdAt])
}
